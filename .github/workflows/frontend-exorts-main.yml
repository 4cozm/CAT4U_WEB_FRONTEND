name: Build & Deploy (main)

on:
    push:
        branches: [main]
    # í•„ìš”í•˜ë©´ PR ë¹Œë“œë„ ì¼œì„¸ìš”
    # pull_request:
    #   branches: [main]

jobs:
    build-and-export:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 9

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build static export
              run: pnpm build

            - name: Set export timestamp
              id: timestamp
              run: echo "VALUE=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

            - name: Compose artifact name
              run: echo "ARTIFACT_NAME=frontend-export-${{ steps.timestamp.outputs.VALUE }}" >> $GITHUB_ENV

            - name: Upload export artifact
              uses: actions/upload-artifact@v4
              with:
                  name: main${{ steps.timestamp.outputs.VALUE }}
                  path: out/

            # âœ… main: ë°±ì—”ë“œì— ìµœì‹  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            - name: Trigger Backend Artifact Update
              env:
                  API_KEY: ${{ secrets.ARTIFACT_API_KEY }}
              run: |
                  curl -sS -X POST "https://web.cat4u.store/api/github/downloadLatestArtifact" \
                    -H "x-api-key: ${API_KEY}" \
                    -H "Content-Type: application/json"

            - name: Notify Discord (Success, main)
              if: success()
              env:
                  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  SHA_SHORT="${GITHUB_SHA::7}"
                  cat > payload.json <<'JSON'
                  {
                    "embeds": [{
                      "title": "ðŸš€ main ë¹Œë“œ ì„±ê³µ & ë°°í¬ íŠ¸ë¦¬ê±°",
                      "description": "ì•„í‹°íŒ©íŠ¸: ${ARTIFACT}\në¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\nëŸ°: ${RUN_URL}",
                      "color": 5763719
                    }]
                  }
                  JSON
                  sed -i "s|\${ARTIFACT}|${ARTIFACT_NAME}|g" payload.json
                  sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
                  sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
                  sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
                  curl -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"

            - name: Notify Discord (Failure, main)
              if: failure()
              env:
                  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  SHA_SHORT="${GITHUB_SHA::7}"
                  cat > payload.json <<'JSON'
                  {
                    "embeds": [{
                      "title": "ðŸ”¥ main ë¹Œë“œ ì‹¤íŒ¨",
                      "description": "ë¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\nëŸ°: ${RUN_URL}",
                      "color": 15548997
                    }]
                  }
                  JSON
                  sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
                  sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
                  sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
                  curl -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"
